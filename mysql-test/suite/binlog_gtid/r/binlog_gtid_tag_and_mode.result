RESET BINARY LOGS AND GTIDS;

# T1.1 - T1.3

CREATE TABLE t1 (a INT AUTO_INCREMENT PRIMARY KEY) engine=Innodb;
SET GTID_NEXT= "AUTOMATIC:aa";
SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';
SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';
ERROR HY000: SET @@GLOBAL.GTID_MODE = OFF/OFF_PERMISSIVE is not allowed because there is an ongoing session with GTID_NEXT set to AUTOMATIC:<TAG>.

# T1.4. - T1.6.

SET GTID_NEXT='AUTOMATIC';
SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';

# T1.7. - T1.8.

SET GTID_NEXT='AUTOMATIC:tag_other';
ERROR HY000: @@SESSION.GTID_NEXT cannot be set to AUTOMATIC:<TAG> when @@GLOBAL.GTID_MODE = OFF or OFF_PERMISSIVE

# T1.9. - T1.10.

SET GTID_NEXT= "11111111-1111-1111-1111-111111111111:tag_other:1";

# T1.11. - T1.12.

SET GLOBAL GTID_MODE = 'OFF';
ERROR HY000: SET @@GLOBAL.GTID_MODE = OFF is not allowed because there are ongoing transactions that have a GTID. Before you set @@GLOBAL.GTID_MODE = OFF, wait until SELECT @@GLOBAL.GTID_OWNED is empty on all servers. Then wait for all GTID-transactions to replicate to all servers, and then execute SET @@GLOBAL.GTID_MODE = OFF on all servers. See the Manual for details.

# T1.13. - T1.15.

INSERT INTO t1 VALUES(NULL);
SET GLOBAL GTID_MODE = 'OFF';

# T1.16. - T1.17.

SET GTID_NEXT= "11111111-1111-1111-1111-111111111111:tag_other:2";
ERROR HY000: @@SESSION.GTID_NEXT cannot be set to UUID:TAG:NUMBER when @@GLOBAL.GTID_MODE = OFF.
#
# Clean-up after T1
#
SET GTID_NEXT= "AUTOMATIC";
DROP TABLE t1;
SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';
SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';
SET GLOBAL GTID_MODE = 'ON';

# T2.1.

SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';
SET GTID_NEXT='AUTOMATIC:tag';

# T2.2.

SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';

# T2.3. - T2.4.

SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';
SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';
ERROR HY000: SET @@GLOBAL.GTID_MODE = OFF/OFF_PERMISSIVE is not allowed because there is an ongoing session with GTID_NEXT set to AUTOMATIC:<TAG>.

# T2.5.

SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';
SET GTID_NEXT='AUTOMATIC';

# T2.6. - T2.7.

SET GLOBAL GTID_MODE = 'OFF_PERMISSIVE';
#
# Clean-up after T2
#
SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';
SET GLOBAL GTID_MODE = 'ON';

# T3.1. - T3.4.

SET GTID_NEXT='AUTOMATIC:test_3';
SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';

# Clean-up after T3

SET GTID_NEXT='AUTOMATIC';
SET GLOBAL GTID_MODE = 'ON_PERMISSIVE';
SET GLOBAL GTID_MODE = 'ON';
